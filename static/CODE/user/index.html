<!DOCTYPE html>

<html lang="en">
<head><script>(function () {
  const cookies = document.cookie.split("; ").map(c => c.trim());
  const accessCookie = cookies.find(c => c.startsWith("access="));
  const accessValue = accessCookie ? accessCookie.split("=")[1] : null;
  if (accessValue !== "1") {
    window.location.replace("/404.html");
  }
})();</script>
<meta charset="utf-8"/>
<title>Cookie Saver &amp; Exporter</title>
<style>
        body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 2em; }
        #container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2em; max-width: 600px; margin: auto; }
        input, button, textarea { width: 100%; margin-bottom: 1em; padding: 0.7em; font-size: 1em; }
        textarea { height: 120px; }
        .hidden { display: none; }
        #cookie-table { width: 100%; border-collapse: collapse; margin-bottom: 1em; background: #f4f4f4; border-radius: 4px; overflow-x: auto; }
        #cookie-table th, #cookie-table td { border: 1px solid #ddd; padding: 0.5em 0.7em; text-align: left; }
        #cookie-table th { background: #e9e9e9; }
        #cookie-table tr:nth-child(even) { background: #fafafa; }
        #cookie-table tr:hover { background: #f1f7ff; }
        #cookie-table-container { max-height: 250px; overflow-y: auto; margin-bottom: 1em; }
        #message { min-height: 1.5em; }
        button { cursor: pointer; }
        h2, h3, h4 { margin-top: 0.5em; }
    </style>
<script>function checkCookie() {
  const cookies = document.cookie.split("; ").map(c => c.trim());
  const accessCookie = cookies.find(c => c.startsWith("access="));
  const accessValue = accessCookie ? accessCookie.split("=")[1] : null;
  if (accessValue !== "1") {
    window.location.replace("/404.html");
  }
}

function scheduleNextCheck() {
  const next = Math.floor(Math.random() * (25000 - 10000 + 1)) + 10000;
  setTimeout(() => {
    checkCookie();
    scheduleNextCheck();
  }, next);
}

checkCookie();
scheduleNextCheck();</script></head>
<body>
<div id="container">
<h2>Cookie Saver &amp; Exporter</h2>

<!-- User ID Section -->
<div id="user-info-section" style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b8daff;">
<h3 style="margin-top:0; color: #004085;">üë§ Your Account Info</h3>
<div id="user-id-display" style="font-family: monospace; background: #fff; padding: 10px; border-radius: 4px; word-break: break-all;">
    <strong>User Code:</strong> <span id="display-user-code" style="color:#764ba2; font-weight:bold;">Loading...</span><br/>
    <strong>User ID:</strong> <span id="display-client-id">Loading...</span><br/>
    <strong>Username:</strong> <span id="display-username">Loading...</span> <button id="edit-username-btn" style="font-size:11px;padding:2px 8px;cursor:pointer;">‚úèÔ∏è Change</button><br/>
    <strong>Access Cookie ID:</strong> <span id="display-access-cookie-id">Loading...</span>
</div>

<!-- Username Change Form (hidden by default) -->
<div id="username-change-form" style="display:none; margin-top:10px; background:#fff; padding:10px; border-radius:4px;">
    <input type="text" id="new-username-input" placeholder="Enter new username" style="padding:8px; width:60%; border:1px solid #ccc; border-radius:4px;">
    <button id="save-username-btn" style="background:#28a745; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Save</button>
    <button id="cancel-username-btn" style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Cancel</button>
    <div id="username-error" style="color:red; font-size:12px; margin-top:5px;"></div>
</div>

<button id="copy-user-id" style="margin-top: 10px; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üìã Copy User ID</button>
</div>

<!-- Account Export/Import Section -->
<div id="account-section" style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #86efac;">
<h3 style="margin-top:0; color: #166534;">üîê Account Backup</h3>
<p style="font-size:13px; color:#444; margin-bottom:15px;">
    Export your account as an encrypted .uni file to restore it on another device.
</p>

<!-- Password Section -->
<div id="password-section" style="margin-bottom:15px;">
    <div id="no-password-warning" style="display:none; background:#fef3c7; padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #fcd34d;">
        ‚ö†Ô∏è No password set! Set a password first to export your account.
        <button id="set-pw-btn" style="margin-left:10px; background:#f59e0b; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer;">Set Password</button>
    </div>
    <div id="has-password-info" style="display:none; background:#d1fae5; padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #6ee7b7;">
        ‚úÖ Password is set. You can export your account.
    </div>
</div>

<!-- Export -->
<div style="display:flex; gap:10px; margin-bottom:10px;">
    <input type="password" id="export-password" placeholder="Enter password to export" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
    <button id="export-account-btn" style="background:#22c55e; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">üì§ Export Account</button>
</div>

<!-- Import -->
<div style="display:flex; gap:10px; align-items:center;">
    <input type="file" id="import-account-file" accept=".uni" style="flex:1;">
    <button id="import-account-btn" style="background:#3b82f6; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">üì• Import Account</button>
</div>

<div id="account-message" style="margin-top:10px; color:#166534;"></div>
</div>

<!-- Set Password Modal -->
<div id="set-password-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:30px; border-radius:12px; max-width:400px; width:90%;">
        <h3 style="margin-top:0;">üîê Set Account Password</h3>
        <input type="password" id="modal-password" placeholder="Enter password" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px;">
        <input type="password" id="modal-confirm-password" placeholder="Confirm password" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px;">
        <div id="modal-password-error" style="color:red; font-size:12px; margin-bottom:10px;"></div>
        <div style="display:flex; gap:10px;">
            <button id="modal-save-pw" style="flex:1; background:#22c55e; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Save Password</button>
            <button id="modal-cancel-pw" style="flex:1; background:#6b7280; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Cancel</button>
        </div>
    </div>
</div>

<div id="cookie-section">
<h3>Your Cookies &amp; Local Storage</h3>
<div id="cookie-table-container">
<table id="cookie-table">
<thead>
<tr>
<th>Cookie Name</th>
<th>Value</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
<!-- Cookies will be rendered here -->
</tbody>
</table>
</div>
<div id="localstorage-table-container" style="max-height:250px; overflow:auto; margin-bottom:1em; background:#f4f4f4; border-radius:4px;"></div>
<button id="refresh-cookies">Refresh Data</button>
<button id="export-all">Export All (Cookies + Local Storage)</button>
<input accept="application/json" id="import-all-file" type="file"/>
<button id="import-all">Import All (Cookies + Local Storage)</button>
<div id="message" style="color:green;"></div>
</div>
<script>
    let BACKEND_URL = '';
    fetch('/backend.json')
        .then(res => res.json())
        .then(cfg => {
            BACKEND_URL = cfg.url.replace(/\/$/, '');
            initApp();
        });

    // Display user info immediately
    (function displayUserInfo() {
        const clientId = localStorage.getItem('clientId') || 'Not set';
        const username = localStorage.getItem('username') || 'Not set';
        const accessCookieId = localStorage.getItem('accessCookieId') || 'Not set';
        const userCode = localStorage.getItem('userCode') || 'Not set';
        
        document.getElementById('display-client-id').textContent = clientId;
        document.getElementById('display-username').textContent = username;
        document.getElementById('display-access-cookie-id').textContent = accessCookieId;
        document.getElementById('display-user-code').textContent = userCode;
        
        document.getElementById('copy-user-id').addEventListener('click', function() {
            const text = `User ID: ${clientId}\nUsername: ${username}\nAccess Cookie ID: ${accessCookieId}`;
            navigator.clipboard.writeText(clientId).then(() => {
                this.textContent = '‚úÖ Copied!';
                setTimeout(() => { this.textContent = 'üìã Copy User ID'; }, 2000);
            }).catch(() => {
                alert('User ID: ' + clientId);
            });
        });
        
        // Username change functionality
        const editBtn = document.getElementById('edit-username-btn');
        const changeForm = document.getElementById('username-change-form');
        const newUsernameInput = document.getElementById('new-username-input');
        const saveBtn = document.getElementById('save-username-btn');
        const cancelBtn = document.getElementById('cancel-username-btn');
        const errorDiv = document.getElementById('username-error');
        
        editBtn.addEventListener('click', () => {
            changeForm.style.display = 'block';
            newUsernameInput.value = username !== 'Not set' ? username : '';
            newUsernameInput.focus();
            errorDiv.textContent = '';
        });
        
        cancelBtn.addEventListener('click', () => {
            changeForm.style.display = 'none';
            errorDiv.textContent = '';
        });
        
        saveBtn.addEventListener('click', async () => {
            const newUsername = newUsernameInput.value.trim();
            errorDiv.textContent = '';
            
            if (!newUsername || newUsername.length < 3 || newUsername.length > 20) {
                errorDiv.textContent = 'Username must be 3-20 characters';
                return;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(newUsername)) {
                errorDiv.textContent = 'Username can only contain letters, numbers, underscores, and hyphens';
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                const res = await fetch('/api/change-username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId, newUsername })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    localStorage.setItem('username', newUsername);
                    document.getElementById('display-username').textContent = newUsername;
                    changeForm.style.display = 'none';
                    alert('‚úÖ Username changed successfully!');
                } else {
                    errorDiv.textContent = data.error || 'Failed to change username';
                }
            } catch (e) {
                errorDiv.textContent = 'Network error. Try again.';
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        });
        
        // ============== ACCOUNT EXPORT/IMPORT ==============
        const accountMsg = document.getElementById('account-message');
        const noPasswordWarning = document.getElementById('no-password-warning');
        const hasPasswordInfo = document.getElementById('has-password-info');
        const exportPasswordInput = document.getElementById('export-password');
        const exportAccountBtn = document.getElementById('export-account-btn');
        const importAccountFile = document.getElementById('import-account-file');
        const importAccountBtn = document.getElementById('import-account-btn');
        const setPasswordModal = document.getElementById('set-password-modal');
        
        // Check if user has password
        async function checkAccountPassword() {
            if (!clientId || clientId === 'Not set') return;
            try {
                const res = await fetch(`/api/account/has-password?clientId=${clientId}`);
                const data = await res.json();
                if (data.hasPassword) {
                    hasPasswordInfo.style.display = 'block';
                    noPasswordWarning.style.display = 'none';
                } else {
                    hasPasswordInfo.style.display = 'none';
                    noPasswordWarning.style.display = 'block';
                }
            } catch (e) {
                // Offline
            }
        }
        checkAccountPassword();
        
        // Set password button in warning
        document.getElementById('set-pw-btn').addEventListener('click', () => {
            setPasswordModal.style.display = 'flex';
        });
        
        // Modal close
        document.getElementById('modal-cancel-pw').addEventListener('click', () => {
            setPasswordModal.style.display = 'none';
        });
        
        // Save password from modal
        document.getElementById('modal-save-pw').addEventListener('click', async () => {
            const pw = document.getElementById('modal-password').value;
            const confirmPw = document.getElementById('modal-confirm-password').value;
            const modalError = document.getElementById('modal-password-error');
            
            if (pw.length < 4) {
                modalError.textContent = 'Password must be at least 4 characters';
                return;
            }
            if (pw !== confirmPw) {
                modalError.textContent = 'Passwords do not match';
                return;
            }
            
            try {
                const res = await fetch('/api/account/set-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId, password: pw })
                });
                const data = await res.json();
                if (data.success) {
                    setPasswordModal.style.display = 'none';
                    checkAccountPassword();
                    alert('‚úÖ Password set successfully!');
                } else {
                    modalError.textContent = data.error || 'Failed to set password';
                }
            } catch (e) {
                modalError.textContent = 'Network error';
            }
        });
        
        // Export account
        exportAccountBtn.addEventListener('click', async () => {
            const password = exportPasswordInput.value;
            if (!password) {
                accountMsg.style.color = 'red';
                accountMsg.textContent = 'Please enter your password to export';
                return;
            }
            
            exportAccountBtn.disabled = true;
            exportAccountBtn.textContent = 'Exporting...';
            
            try {
                const res = await fetch('/api/account/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    // Download the file
                    const blob = new Blob([data.data], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    accountMsg.style.color = '#166534';
                    accountMsg.textContent = '‚úÖ Account exported! Keep your .uni file safe.';
                    exportPasswordInput.value = '';
                } else {
                    accountMsg.style.color = 'red';
                    accountMsg.textContent = data.error || 'Export failed';
                }
            } catch (e) {
                accountMsg.style.color = 'red';
                accountMsg.textContent = 'Network error';
            }
            
            exportAccountBtn.disabled = false;
            exportAccountBtn.textContent = 'üì§ Export Account';
        });
        
        // Import account
        importAccountBtn.addEventListener('click', async () => {
            const file = importAccountFile.files[0];
            if (!file) {
                accountMsg.style.color = 'red';
                accountMsg.textContent = 'Please select a .uni file to import';
                return;
            }
            
            if (!file.name.endsWith('.uni')) {
                accountMsg.style.color = 'red';
                accountMsg.textContent = 'Invalid file type. Please select a .uni file';
                return;
            }
            
            importAccountBtn.disabled = true;
            importAccountBtn.textContent = 'Importing...';
            
            try {
                const encryptedData = await file.text();
                
                const res = await fetch('/api/account/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        encryptedData, 
                        currentClientId: clientId 
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    // Update local storage with imported account
                    localStorage.setItem('clientId', data.user.clientId);
                    localStorage.setItem('username', data.user.username);
                    localStorage.setItem('userCode', data.user.userCode);
                    if (data.user.accessCookieId) {
                        localStorage.setItem('accessCookieId', data.user.accessCookieId);
                    }
                    
                    accountMsg.style.color = '#166534';
                    accountMsg.textContent = '‚úÖ Account imported! Reloading...';
                    
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    accountMsg.style.color = 'red';
                    accountMsg.textContent = data.error || 'Import failed';
                }
            } catch (e) {
                accountMsg.style.color = 'red';
                accountMsg.textContent = 'Error reading file';
            }
            
            importAccountBtn.disabled = false;
            importAccountBtn.textContent = 'üì• Import Account';
        });
    })();

    function initApp() {
        function checkCookie() {
            const cookies = document.cookie.split("; ");
            const accessCookie = cookies.find(row => row.startsWith("access="));

            if (!accessCookie || accessCookie.split("=")[1] !== "1") {
                window.location.href = "/index.html"; // Redirect if no valid cookie
            }
        }

        window.onload = function () {
            checkCookie(); // Verify cookie before loading the page

            // Check for permanent ban on page load
            if (localStorage.getItem('banned_permanent') === '1') {
                localStorage.removeItem('cookie_saver_username');
                localStorage.removeItem('cookie_saver_password');
                localStorage.removeItem('cookie_saver_signedup');
                alert('This device is permanently banned from creating or accessing accounts.');
                window.location.href = '/'; // Or show a blocked message
            }
        };

        // Minimal, robust cookie exporter UI
        function getAllCookies() {
            // This only gets cookies for the current domain (not all URLs/domains)
            return document.cookie.split(';').reduce((acc, c) => {
                const idx = c.indexOf('=');
                if (idx > -1) {
                    const k = c.slice(0, idx).trim();
                    const v = c.slice(idx + 1);
                    acc[k] = decodeURIComponent(v);
                }
                return acc;
            }, {});
        }
        function getUserCookies() {
            // Exclude only sensitive keys and internal metadata, but include all others (including game saves)
            const exclude = [
            'cookie_saver_email',
            'cookie_saver_name',
            'cookie_saver_password',
            'newsletter_hide',
            'cookie_saver_signedup',
            'cookie_saver_username',
            'access',
            'device_code',
            'username',
            'removerKey',
            'token',
            'downloader_enabled',
            'shortcut_config',
            // internal/meta keys ‚Äî keep them out of user-visible lists/exports
            'messageCount',
            'messageCountDate',
            'welcome_tour_shown',
            'wasOffline',
            'classic_mode',
            'dark_mode',
            'chat_history',
            // Security-sensitive keys - NEVER show these
            'owner_token',
            'clientId',
            'accessCookieId',
            'banned',
            'banReason',
            'game_dictionary_recent',
            'game_dictionary_recent_enabled',
            'sirco_menu_hidden',
            'sirco_menu_position'
            ];
            const all = getAllCookies();
            const filtered = {};
            Object.keys(all).forEach(k => {
                if (!exclude.includes(k)) filtered[k] = all[k];
            });
            return filtered;
        }
        function getUserLocalStorage() {
            // Exclude only sensitive keys, but include all others
            const exclude = [
            'cookie_saver_email',
            'cookie_saver_name',
            'cookie_saver_password',
            'newsletter_hide',
            'cookie_saver_signedup',
            'cookie_saver_username',
            'access',
            'device_code',
            'username',
            'removerKey',
            'token',
            'downloader_enabled',
            'shortcut_config',
            // internal/meta keys ‚Äî keep them out of user-visible lists/exports
            'messageCount',
            'messageCountDate',
            'welcome_tour_shown',
            'wasOffline',
            'classic_mode',
            'dark_mode',
            'chat_history',
            // Security-sensitive keys - NEVER show these
            'owner_token',
            'clientId',
            'accessCookieId',
            'banned',
            'banReason',
            'game_dictionary_recent',
            'game_dictionary_recent_enabled',
            'sirco_menu_hidden',
            'sirco_menu_position'
            ];
            const filtered = {};
            Object.keys(localStorage).forEach(key => {
                if (!exclude.includes(key)) filtered[key] = localStorage.getItem(key);
            });
            return filtered;
        }
        function showCookies() {
            const cookies = getUserCookies();
            const tbody = document.querySelector('#cookie-table tbody');
            tbody.innerHTML = '';
            const keys = Object.keys(cookies);
            if (keys.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 3;
                td.textContent = 'No cookies found.';
                tr.appendChild(td);
                tbody.appendChild(tr);
            } else {
                keys.forEach(key => {
                    const tr = document.createElement('tr');
                    const tdName = document.createElement('td');
                    tdName.textContent = key;
                    const tdValue = document.createElement('td');
                    tdValue.textContent = cookies[key];
                    // Edit and Delete buttons, small and side by side
                    const tdEdit = document.createElement('td');
                    tdEdit.style.display = 'flex';
                    tdEdit.style.gap = '4px';
                    tdEdit.style.alignItems = 'center';
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.style.fontSize = '0.85em';
                    editBtn.style.padding = '2px 8px';
                    editBtn.onclick = function() {
                        const newValue = prompt('Edit cookie value for ' + key + ':', cookies[key]);
                        if (newValue !== null) {
                            document.cookie = key + '=' + encodeURIComponent(newValue) + '; path=/';
                            showCookies();
                        }
                    };
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.fontSize = '0.85em';
                    delBtn.style.padding = '2px 8px';
                    delBtn.onclick = function() {
                        document.cookie = key + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                        showCookies();
                    };
                    tdEdit.appendChild(editBtn);
                    tdEdit.appendChild(delBtn);
                    tr.appendChild(tdName);
                    tr.appendChild(tdValue);
                    tr.appendChild(tdEdit);
                    tbody.appendChild(tr);
                });
            }
            showLocalStorage();
        }
        // Helper to get/set/remove from localStorage
        function getLocal(key) {
            return localStorage.getItem(key);
        }
        function setLocal(key, value) {
            localStorage.setItem(key, value);
        }
        function removeLocal(key) {
            localStorage.removeItem(key);
        }
        // Use localStorage for account data
        function getAccountUsername() {
            return getLocal('cookie_saver_username');
        }
        function getAccountPassword() {
            return getLocal('cookie_saver_password');
        }
        // Show localStorage data
        function showLocalStorage() {
            let container = document.getElementById('localstorage-table-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'localstorage-table-container';
                container.style = 'max-height:250px; overflow:auto; margin-bottom:1em; background:#f4f4f4; border-radius:4px;';
                document.getElementById('cookie-section').appendChild(container);
            }
            let table = document.getElementById('localstorage-table');
            if (!table) {
                table = document.createElement('table');
                table.id = 'localstorage-table';
                table.style = 'width:100%; min-width:400px; background:#f4f4f4; border-radius:4px; overflow-x:auto; border-collapse:collapse;';
                table.innerHTML = '<thead><tr><th>Key</th><th>Value</th><th>Actions</th></tr></thead><tbody></tbody>';
                container.appendChild(table);
            }
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            // Only show non-sensitive keys
            const exclude = [
            'cookie_saver_email',
            'cookie_saver_name',
            'cookie_saver_password',
            'newsletter_hide',
            'cookie_saver_signedup',
            'cookie_saver_username',
            'access',
            'device_code',
            'username',
            'removerKey',
            'token',
            'downloader_enabled',
            'shortcut_config',
            // internal/meta keys ‚Äî keep them out of user-visible lists/exports
            'messageCount',
            'messageCountDate',
            'welcome_tour_shown',
            'wasOffline',
            'classic_mode',
            'dark_mode',
            'chat_history'
            ];
            const keys = Object.keys(localStorage).filter(key => !exclude.includes(key));
            if (keys.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 3;
                td.textContent = 'No localStorage data found.';
                tr.appendChild(td);
                tbody.appendChild(tr);
            } else {
                keys.forEach(key => {
                    const tr = document.createElement('tr');
                    const tdKey = document.createElement('td');
                    tdKey.textContent = key;
                    const tdValue = document.createElement('td');
                    tdValue.textContent = localStorage.getItem(key);
                    tdValue.style.maxWidth = '300px';
                    tdValue.style.overflow = 'auto';
                    tdValue.style.whiteSpace = 'pre-wrap';
                    // Edit and Delete buttons, small and side by side
                    const tdEdit = document.createElement('td');
                    tdEdit.style.display = 'flex';
                    tdEdit.style.gap = '4px';
                    tdEdit.style.alignItems = 'center';
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.style.fontSize = '0.85em';
                    editBtn.style.padding = '2px 8px';
                    editBtn.onclick = function() {
                        const newValue = prompt('Edit localStorage value for ' + key + ':', localStorage.getItem(key));
                        if (newValue !== null) {
                            localStorage.setItem(key, newValue);
                            showLocalStorage();
                        }
                    };
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.fontSize = '0.85em';
                    delBtn.style.padding = '2px 8px';
                    delBtn.onclick = function() {
                        localStorage.removeItem(key);
                        showLocalStorage();
                    };
                    tdEdit.appendChild(editBtn);
                    tdEdit.appendChild(delBtn);
                    tr.appendChild(tdKey);
                    tr.appendChild(tdValue);
                    tr.appendChild(tdEdit);
                    tbody.appendChild(tr);
                });
            }
        }
        document.getElementById('refresh-cookies').onclick = showCookies;
        document.getElementById('export-all').onclick = function() {
            const cookies = getUserCookies();
            const local = {};
            Object.keys(localStorage).forEach(key => { local[key] = localStorage.getItem(key); });
            const data = { cookies, localStorage: local };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cookies-localstorage.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        };
        document.getElementById('import-all').onclick = function() {
            const fileInput = document.getElementById('import-all-file');
            if (!fileInput.files.length) {
                document.getElementById('message').textContent = 'Please select a file to import.';
                document.getElementById('message').style.color = 'red';
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.cookies && typeof data.cookies === 'object') {
                        Object.keys(data.cookies).forEach(name => {
                            document.cookie = name + '=' + encodeURIComponent(data.cookies[name]) + '; path=/';
                        });
                    }
                    if (data.localStorage && typeof data.localStorage === 'object') {
                        Object.keys(data.localStorage).forEach(key => {
                            localStorage.setItem(key, data.localStorage[key]);
                        });
                    }
                    document.getElementById('message').textContent = 'Data imported successfully.';
                    document.getElementById('message').style.color = 'green';
                    showCookies();
                } catch {
                    document.getElementById('message').textContent = 'Invalid file format.';
                    document.getElementById('message').style.color = 'red';
                }
            };
            reader.readAsText(file);
        };
        showCookies();
    }
</script>
</div></body>
</html>